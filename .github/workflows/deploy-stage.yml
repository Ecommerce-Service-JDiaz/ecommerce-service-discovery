name: Deploy to Staging

on:
  push:
    branches:
      - staging
  workflow_dispatch:

env:
  REGISTRY: docker.io
  DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
  IMAGE_NAME: ${{ secrets.DOCKERHUB_USERNAME }}/service-discovery
  KUBERNETES_NAMESPACE: staging
  ENVIRONMENT: stage
  PROJECT_VERSION: 0.1.0
  AZURE_RESOURCE_GROUP: ${{ secrets.AZURE_RESOURCE_GROUP_STAGE }}
  AZURE_AKS_CLUSTER_NAME: ${{ secrets.AZURE_AKS_CLUSTER_NAME_STAGE }}

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 11
        uses: actions/setup-java@v4
        with:
          java-version: '11'
          distribution: 'temurin'
          cache: maven

      - name: Build with Maven
        run: ./mvnw clean package -DskipTests

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            ${{ env.DOCKERHUB_USERNAME }}/service-discovery:${{ github.sha }}
            ${{ env.DOCKERHUB_USERNAME }}/service-discovery:latest-stage
          build-args: |
            PROJECT_VERSION=${{ env.PROJECT_VERSION }}

  deploy:
    needs: build-and-push
    runs-on: ubuntu-latest
    environment: staging
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Set up kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'latest'

      - name: Azure Kubernetes Service set context
        uses: azure/aks-set-context@v3
        with:
          resource-group: ${{ env.AZURE_RESOURCE_GROUP }}
          cluster-name: ${{ env.AZURE_AKS_CLUSTER_NAME }}

      - name: Create namespace if not exists
        run: |
          kubectl create namespace ${{ env.KUBERNETES_NAMESPACE }} --dry-run=client -o yaml | kubectl apply -f -

      - name: Create ConfigMap
        run: |
          kubectl create configmap service-discovery-config \
            --from-file=application.yml=src/main/resources/application.yml \
            --from-file=application-stage.yml=src/main/resources/application-stage.yml \
            -n ${{ env.KUBERNETES_NAMESPACE }} \
            --dry-run=client -o yaml | kubectl apply -f -

      - name: Create Docker Hub secret (for private images)
        run: |
          kubectl create secret docker-registry dockerhub-secret \
            --docker-server=docker.io \
            --docker-username=${{ secrets.DOCKERHUB_USERNAME }} \
            --docker-password=${{ secrets.DOCKERHUB_TOKEN }} \
            -n ${{ env.KUBERNETES_NAMESPACE }} \
            --dry-run=client -o yaml | kubectl apply -f - || true

      - name: Deploy to Kubernetes
        run: |
          IMAGE_TAG="${{ env.DOCKERHUB_USERNAME }}/service-discovery:${{ github.sha }}"
          SPRING_PROFILE="${{ env.ENVIRONMENT }}"
          ZIPKIN_URL="${{ secrets.ZIPKIN_BASE_URL }}"
          sed "s|IMAGE_TAG|${IMAGE_TAG}|g; s|SPRING_PROFILE|${SPRING_PROFILE}|g; s|ZIPKIN_BASE_URL|${ZIPKIN_URL}|g" k8s/deployment-stage.yaml | kubectl apply -f - -n ${{ env.KUBERNETES_NAMESPACE }}
          kubectl apply -f k8s/service.yaml -n ${{ env.KUBERNETES_NAMESPACE }}

      - name: Wait for deployment rollout
        run: |
          kubectl rollout status deployment/service-discovery -n ${{ env.KUBERNETES_NAMESPACE }} --timeout=5m

      - name: Verify deployment
        run: |
          kubectl get pods -n ${{ env.KUBERNETES_NAMESPACE }}
          kubectl get svc -n ${{ env.KUBERNETES_NAMESPACE }}

